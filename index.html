// ... (resto del código HTML y CSS igual) ...

<script>
    let qrInstance = null;

    function generateQR() {
        const text = document.getElementById('text').value;
        const size = parseInt(document.getElementById('size').value);
        const logoInput = document.getElementById('logo');
        
        if (!text) {
            alert('Por favor ingresa un texto o URL');
            return;
        }

        // Limpiar QR anterior
        document.getElementById('qrcode').innerHTML = '';
        
        // Crear nuevo QR
        qrInstance = new QRCode(document.getElementById('qrcode'), {
            text: text,
            width: size,
            height: size,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });

        // Si hay una imagen seleccionada
        if (logoInput.files && logoInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const logo = new Image();
                logo.src = e.target.result;
                logo.onload = function() {
                    // Aumentamos el tiempo de espera para asegurar que el QR esté listo
                    setTimeout(() => {
                        addLogoToQR(logo, size);
                    }, 200); // Aumentado a 200ms
                };
            };
            reader.readAsDataURL(logoInput.files[0]);
        }

        document.getElementById('downloadBtn').style.display = 'inline-block';
    }

    function addLogoToQR(logo, size) {
        const canvas = document.querySelector('#qrcode canvas');
        if (!canvas) {
            setTimeout(() => addLogoToQR(logo, size), 100);
            return;
        }

        const ctx = canvas.getContext('2d');

        // Calcular tamaño y posición del logo
        const logoSize = size * 0.25; // Aumentado a 25% del tamaño del QR
        const logoX = (size - logoSize) / 2;
        const logoY = (size - logoSize) / 2;

        // Crear un área blanca para el logo
        ctx.fillStyle = 'white';
        ctx.fillRect(logoX - 2, logoY - 2, logoSize + 4, logoSize + 4);

        // Dibujar el logo con bordes redondeados
        ctx.save();
        ctx.beginPath();
        ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 0, Math.PI * 2, true);
        ctx.closePath();
        ctx.clip();

        // Dibujar el logo
        ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
        
        // Restaurar el contexto
        ctx.restore();

        // Agregar un borde al logo
        ctx.beginPath();
        ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 0, Math.PI * 2, true);
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.stroke();
    }

    function downloadQR() {
        const canvas = document.querySelector('#qrcode canvas');
        if (!canvas) {
            alert('Por favor, genera primero el código QR');
            return;
        }
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.download = 'qr-code.png';
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
