function addLogoToQR(logo, size) {
    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas) {
        setTimeout(() => addLogoToQR(logo, size), 500); // Aumentado el tiempo de espera
        return;
    }

    const ctx = canvas.getContext('2d');

    // Aumentar el tamaño del logo y ajustar la posición
    const logoSize = Math.floor(size * 0.3); // 30% del tamaño del QR
    const padding = 0; // Puedes ajustar este valor si necesitas más espacio alrededor del logo
    const logoX = Math.floor((size - logoSize) / 2);
    const logoY = Math.floor((size - logoSize) / 2);

    // Limpiar el área donde irá el logo
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(logoX - padding, logoY - padding, 
                logoSize + (padding * 2), logoSize + (padding * 2));

    // Crear máscara circular para el logo
    ctx.save();
    ctx.beginPath();
    ctx.arc(logoX + logoSize/2, logoY + logoSize/2, 
            logoSize/2, 0, Math.PI * 2, true);
    ctx.closePath();
    ctx.clip();

    // Dibujar el logo
    try {
        ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
    } catch (e) {
        console.error('Error al dibujar el logo:', e);
    }

    ctx.restore();

    // Dibujar borde blanco alrededor del logo
    ctx.beginPath();
    ctx.arc(logoX + logoSize/2, logoY + logoSize/2, 
            logoSize/2 + 2, 0, Math.PI * 2, true);
    ctx.strokeStyle = '#FFFFFF';
    ctx.lineWidth = 4;
    ctx.stroke();
}

// También modificaremos la función generateQR para aumentar el tiempo de espera
function generateQR() {
    const text = document.getElementById('text').value;
    const size = parseInt(document.getElementById('size').value);
    const logoInput = document.getElementById('logo');
    
    if (!text) {
        alert('Por favor ingresa un texto o URL');
        return;
    }

    // Limpiar QR anterior
    document.getElementById('qrcode').innerHTML = '';
    
    // Crear nuevo QR
    qrInstance = new QRCode(document.getElementById('qrcode'), {
        text: text,
        width: size,
        height: size,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });

    // Si hay una imagen seleccionada
    if (logoInput.files && logoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const logo = new Image();
            logo.src = e.target.result;
            logo.onload = function() {
                // Aumentar el tiempo de espera para asegurar que el QR esté completamente generado
                setTimeout(() => {
                    addLogoToQR(logo, size);
                }, 500);
            };
        };
        reader.readAsDataURL(logoInput.files[0]);
    }

    document.getElementById('downloadBtn').style.display = 'inline-block';
}
